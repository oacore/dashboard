name: Container App Prod/Staging Deploy

on:
  push:
    branches:
      - main

  schedule:
    - cron: "0 1 * * *"

  workflow_dispatch:
    inputs:
      target_env:
        description: "Where to deploy"
        required: true
        type: choice
        options:
          - staging
          - prod
        default: staging
      branch:
        description: "Branch to build (default = main)"
        required: true
        default: main

env:
  ACR_NAME: corecontainers
  IMAGE_NAME: core-frontend-dashboard

  RESOURCE_GROUP: core-frontend
  PROD_APP_NAME: core-frontend-dashboard

  STAGING_RESOURCE_GROUP: core-frontend-stage
  STAGING_APP_NAME: core-frontend-stage-dashboard

  SENTRY_DSN: https://d116b39bd427449799cdd1516f6f97a1@sentry.io/2091955
  PORT: 8080

  ALLOWED_PROD_BRANCH: main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: azure
    outputs:
      tag: ${{ steps.vars.outputs.tag }}
      deploy_env: ${{ steps.vars.outputs.deploy_env }}
      app_name: ${{ steps.vars.outputs.app_name }}
      ref_to_build: ${{ steps.vars.outputs.ref_to_build }}
      branch_tag: ${{ steps.vars.outputs.branch_tag }}
      image_tag: ${{ steps.vars.outputs.image_tag }}
      unique_tag: ${{ steps.img.outputs.unique_tag }}

    steps:
      - name: Compute variables
        id: vars
        shell: bash
        run: |
          SHA7="$(echo "${GITHUB_SHA}" | cut -c1-7)"

          if [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            DEPLOY_ENV="prod"
            REF_TO_BUILD="${{ env.ALLOWED_PROD_BRANCH }}"

          elif [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            DEPLOY_ENV="${{ inputs.target_env }}"
            REF_TO_BUILD="${{ inputs.branch }}"

            if [[ "${DEPLOY_ENV}" == "prod" && "${REF_TO_BUILD}" != "${{ env.ALLOWED_PROD_BRANCH }}" ]]; then
              echo "::error title=Blocked prod deployment::Prod deployments are only allowed from '${{ env.ALLOWED_PROD_BRANCH }}'. You selected '${REF_TO_BUILD}'."
              exit 1
            fi
          else
            DEPLOY_ENV="staging"
            REF_TO_BUILD="${GITHUB_REF_NAME}"
          fi

          BRANCH_TAG="$(echo "${REF_TO_BUILD}" | tr '[:upper:]' '[:lower:]' \
            | sed -E 's#[^a-z0-9_.-]+#-#g' | sed -E 's#^-+##; s#-+$##' | cut -c1-40)"

          if [[ "${DEPLOY_ENV}" == "prod" ]]; then
            APP_NAME="${{ env.PROD_APP_NAME }}"
            IMAGE_TAG="prod"
          else
            APP_NAME="${{ env.STAGING_APP_NAME }}"
            IMAGE_TAG="stg-${BRANCH_TAG}"
          fi

          if [[ "${DEPLOY_ENV}" == "prod" ]]; then
            TAG="${SHA7}-prod"
          else
            TAG="${SHA7}-stg"
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "deploy_env=${DEPLOY_ENV}" >> "$GITHUB_OUTPUT"
          echo "app_name=${APP_NAME}" >> "$GITHUB_OUTPUT"
          echo "ref_to_build=${REF_TO_BUILD}" >> "$GITHUB_OUTPUT"
          echo "branch_tag=${BRANCH_TAG}" >> "$GITHUB_OUTPUT"
          echo "image_tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          {
            echo "## Deploy plan"
            echo "- **Trigger:** ${{ github.event_name }}"
            echo "- **Env:** ${{ steps.vars.outputs.deploy_env }}"
            echo "- **Branch:** ${{ steps.vars.outputs.ref_to_build }}"
            echo "- **App:** ${{ steps.vars.outputs.app_name }}"
            echo "- **ACR:** ${{ env.ACR_NAME }}"
            echo "- **Image:** ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}"
            echo "- **Tag (sha7):** ${{ steps.vars.outputs.tag }}"
            echo "- **Tag (env):** ${{ steps.vars.outputs.image_tag }}"
            echo "- **Unique tag:** (computed after checkout)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.vars.outputs.ref_to_build }}

      - name: Compute tags from checked-out code
        id: img
        shell: bash
        run: |
          SHA7="$(git rev-parse --short=7 HEAD)"
          DEPLOY_ENV="${{ steps.vars.outputs.deploy_env }}"
          BRANCH_TAG="${{ steps.vars.outputs.branch_tag }}"
          UNIQUE_TAG="${DEPLOY_ENV}-${BRANCH_TAG}-${SHA7}-${GITHUB_RUN_NUMBER}"
          echo "unique_tag=${UNIQUE_TAG}" >> "$GITHUB_OUTPUT"

          {
            echo ""
            echo "## Image tags (post-checkout)"
            echo "- **Checked-out SHA7:** ${SHA7}"
            echo "- **Unique tag:** ${UNIQUE_TAG}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Docker ACR Login
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Docker Build
        shell: bash
        run: |
          if [[ "${{ steps.vars.outputs.deploy_env }}" == "staging" ]]; then
            NODE_ENV=development
          else
            NODE_ENV=production
          fi

          echo "Building with NODE_ENV=$NODE_ENV"
          echo "Using unique tag: ${{ steps.img.outputs.unique_tag }}"

          docker build \
            --build-arg NODE_ENV=$NODE_ENV \
            --build-arg SENTRY_DSN=${{env.SENTRY_DSN}} \
            --build-arg GA_TRACKING_CODE=${{secrets.GA_TRACKING_CODE}} \
            --build-arg NPM_TOKEN=${{ secrets.NPM_TOKEN }} \
            --build-arg API_KEY=${{ secrets.API_KEY }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.img.outputs.unique_tag }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_tag }} .

      - name: Docker Push
        run: |
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.img.outputs.unique_tag }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_tag }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: azure
    env:
      TAG: ${{ needs.build-and-push.outputs.tag }}
      IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
      UNIQUE_TAG: ${{ needs.build-and-push.outputs.unique_tag }}

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Resolve deploy target
        id: target
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            ENV="prod"
          elif [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            ENV="${{ inputs.target_env }}"
          else
            ENV="staging"
          fi

          if [[ "$ENV" == "prod" ]]; then
            echo "APP=${{ env.PROD_APP_NAME }}" >> $GITHUB_OUTPUT
            echo "RG=${{ env.RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
          else
            echo "APP=${{ env.STAGING_APP_NAME }}" >> $GITHUB_OUTPUT
            echo "RG=${{ env.STAGING_RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
          fi

      - name: Enforce prod branch freeze
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.target_env }}" == "prod" && "${{ needs.build-and-push.outputs.ref_to_build }}" != "${{ env.ALLOWED_PROD_BRANCH }}" ]]; then
              echo "::error title=Blocked prod deployment::Prod deployments are only allowed from '${{ env.ALLOWED_PROD_BRANCH }}'."
              exit 1
            fi
          fi

      - name: Deploy to Azure Container App
        run: |
          az containerapp update \
            --name ${{ steps.target.outputs.APP }} \
            --resource-group ${{ steps.target.outputs.RG }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.UNIQUE_TAG }} \
            --container-name ${{ steps.target.outputs.APP }} \
            --set configuration.ingress.targetPort=${{ env.PORT }}
